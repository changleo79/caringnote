# 🚀 데이터베이스 마이그레이션 실행 가이드

## ⚡ 빠른 실행 (권장)

터미널에서 다음 명령어를 순서대로 실행하세요:

```powershell
# 1. Prisma 클라이언트 생성
npm run db:generate

# 2. 데이터베이스에 스키마 변경사항 적용
npm run db:push
```

---

## 📋 상세 가이드

### 1단계: Prisma 클라이언트 생성

새로 추가된 모델을 사용하기 위해 Prisma 클라이언트를 재생성해야 합니다.

```bash
npm run db:generate
```

**또는 직접 실행:**
```bash
npx prisma generate
```

**성공 메시지:**
```
✔ Generated Prisma Client
```

---

### 2단계: 데이터베이스 마이그레이션

#### 방법 A: DB Push (개발 환경 - 빠름) ✅ 권장

스키마 변경사항을 직접 데이터베이스에 적용합니다.

```bash
npm run db:push
```

**또는 직접 실행:**
```bash
npx prisma db push
```

#### 방법 B: Migrate (프로덕션 환경 - 안전함)

마이그레이션 파일을 생성하고 적용합니다.

```bash
npx prisma migrate dev --name add_resident_family_and_notification
```

---

## ✅ 마이그레이션 확인

### Prisma Studio로 확인

```bash
npm run db:studio
```

브라우저에서 다음을 확인할 수 있습니다:
- `ResidentFamily` 테이블
- `Notification` 테이블
- 기존 테이블들과의 관계

---

## 🎯 추가된 내용

### 새로 생성되는 테이블

1. **ResidentFamily** - 가족-입소자 연결 정보
   - 입소자와 가족 회원을 연결
   - 연결 승인 상태 관리

2. **Notification** - 알림 정보
   - 게시글, 댓글, 연결 요청 등의 알림
   - 읽음/미읽음 상태 관리

### 기존 테이블에 추가된 관계

- **User 테이블**: `residentFamilies`, `notifications` 관계 추가
- **Resident 테이블**: `residentFamilies` 관계 추가

---

## ⚠️ 주의사항

1. **기존 데이터**: 기존 데이터는 모두 유지됩니다
2. **다운타임**: 마이그레이션 중에는 데이터베이스 접근이 일시적으로 제한될 수 있습니다
3. **백업**: 프로덕션 환경에서는 반드시 백업 후 실행하세요

---

## 🐛 문제 해결

### "DATABASE_URL이 설정되지 않았습니다"

`.env.local` 파일에 DATABASE_URL이 설정되어 있는지 확인:

```env
DATABASE_URL="postgresql://..."
```

### "테이블이 이미 존재합니다"

이미 테이블이 있는 경우:
```bash
npx prisma db pull  # 기존 스키마 가져오기
npx prisma generate # 클라이언트 재생성
```

### "Foreign key constraint 오류"

기존 데이터와 충돌이 있는 경우, 데이터를 먼저 확인하세요.

---

## 🎉 완료 후

마이그레이션이 완료되면:

1. ✅ 개발 서버 재시작
   ```bash
   npm run dev
   ```

2. ✅ 새 기능 테스트
   - 입소자 관리 페이지 (`/residents`)
   - 프로필 수정 페이지 (`/profile/edit`)
   - 알림 페이지 (`/notifications`)

3. ✅ API 테스트
   - 입소자 CRUD API
   - 가족-입소자 연결 API
   - 알림 API

---

**마이그레이션 실행 후 알려주세요!** 🚀

