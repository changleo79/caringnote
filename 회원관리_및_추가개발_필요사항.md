# 📋 회원 관리 및 추가 개발 필요 사항

## 📊 현재 상황 분석

### 회원 카테고리
- **FAMILY** (가족 회원)
- **CAREGIVER** (요양원 직원)
- **ADMIN** (관리자)

### 현재 구현 상태
- ✅ 회원가입 (기본 구조)
- ✅ 로그인
- ❌ 회원정보 수정 기능
- ❌ 요양원 회원 관리 기능
- ❌ 입소자 관리 기능
- ❌ 가족-입소자 연결 기능

---

## 🔴 필수 개발 항목

### 1. 회원 카테고리별 기능 구분

#### FAMILY (가족 회원) - 필요한 기능

##### 기본 기능
- [x] 회원가입 (요양원 선택 필수)
- [ ] **회원정보 수정**
  - 이름, 전화번호, 프로필 사진 변경
  - 비밀번호 변경
  - 요양원 변경 (이전 요양원 승인 필요)
- [ ] **비밀번호 재설정**
  - 이메일 인증을 통한 재설정

##### 입소자 관련
- [ ] **입소자 선택/연결**
  - 가족 회원은 입소자와 연결 필요
  - 입소자 선택 시 관계 설정 (부, 모, 자녀, 배우자 등)
  - 여러 입소자와 연결 가능 (예: 부모님 모두)
- [ ] **내가 연결된 입소자 목록 조회**
  - 대시보드에서 연결된 입소자 확인
  - 입소자별 정보 조회

##### 접근 권한
- [ ] **커뮤니티**
  - 연결된 입소자의 게시글만 조회 가능
  - 게시글 작성 불가 (요양원 직원만 가능)
  - 댓글 작성 가능
  - 좋아요 가능
- [ ] **의료 정보**
  - 연결된 입소자의 의료 기록만 조회 가능
  - 의료 기록 작성 불가
- [ ] **쇼핑몰**
  - 연결된 입소자에게 주문 가능
  - 주문 내역 조회
- [ ] **알림**
  - 연결된 입소자 관련 알림만 수신

---

#### CAREGIVER (요양원 직원) - 필요한 기능

##### 기본 기능
- [x] 회원가입 (소속 요양원 선택 필수)
- [ ] **회원정보 수정**
  - 이름, 전화번호, 프로필 사진 변경
  - 비밀번호 변경
  - 소속 요양원 변경 (요양원 승인 필요)
- [ ] **비밀번호 재설정**

##### 입소자 관리
- [ ] **입소자 등록**
  - 입소자 정보 입력 (이름, 생년월일, 성별, 호실 등)
  - 입소자 사진 등록
- [ ] **입소자 목록 조회**
  - 소속 요양원의 모든 입소자 조회
  - 입소자 검색/필터링
- [ ] **입소자 정보 수정/삭제**
  - 입소자 정보 변경
  - 입소자 삭제 (가족 승인 필요)

##### 가족 회원 관리
- [ ] **가족 회원 목록 조회**
  - 소속 요양원에 가입한 가족 회원 목록
  - 입소자별 연결된 가족 회원 확인
- [ ] **가족 회원 승인/거부**
  - 가족 회원의 입소자 연결 요청 승인
  - 가족 회원의 요양원 변경 요청 승인
- [ ] **가족 회원 권한 관리**
  - 가족 회원의 접근 권한 제어

##### 접근 권한
- [ ] **커뮤니티**
  - 소속 요양원의 모든 게시글 조회 가능
  - 게시글 작성 가능 (입소자 선택 필수)
  - 게시글 수정/삭제 가능
  - 댓글 작성/삭제 가능
- [ ] **의료 정보**
  - 소속 요양원의 모든 의료 기록 조회 가능
  - 의료 기록 작성 가능
  - 의료 기록 수정/삭제 가능
- [ ] **쇼핑몰**
  - 상품 등록/수정/삭제 가능 (요양원 전용 상품)
  - 주문 관리
- [ ] **알림**
  - 모든 알림 수신

---

#### ADMIN (관리자) - 필요한 기능

##### 기본 기능
- [ ] **회원정보 수정**
- [ ] **비밀번호 재설정**

##### 요양원 관리
- [ ] **요양원 등록/수정/삭제**
  - 요양원 정보 관리
  - 요양원 승인/거부

##### 전체 회원 관리
- [ ] **전체 회원 목록 조회**
  - 모든 회원 조회 및 관리
- [ ] **회원 권한 관리**
  - 회원 역할 변경
  - 회원 정지/해제

---

### 2. 회원정보 수정 기능

#### 공통 기능
- [ ] **프로필 수정 페이지** (`/profile/edit`)
  - 이름, 전화번호, 프로필 사진 수정
  - 프로필 사진 업로드
- [ ] **비밀번호 변경 페이지** (`/profile/password`)
  - 현재 비밀번호 확인
  - 새 비밀번호 설정
- [ ] **회원정보 조회 API** (`GET /api/users/me`)
- [ ] **회원정보 수정 API** (`PATCH /api/users/me`)
- [ ] **비밀번호 변경 API** (`PATCH /api/users/me/password`)

#### 요양원 변경 (FAMILY, CAREGIVER)
- [ ] **요양원 변경 요청**
  - 새 요양원 선택
  - 변경 사유 입력
- [ ] **요양원 변경 승인 (CAREGIVER/ADMIN)**
  - 요청된 변경사항 승인/거부

---

### 3. 요양원 회원 관리 기능

#### 요양원별 회원 조회
- [ ] **요양원 회원 목록 API** (`GET /api/care-centers/[id]/members`)
  - 가족 회원 목록
  - 요양원 직원 목록
  - 역할별 필터링
- [ ] **요양원 회원 관리 페이지** (`/care-center/members`)
  - CAREGIVER/ADMIN만 접근 가능
  - 회원 목록, 검색, 필터링

#### 회원 승인/관리
- [ ] **회원 가입 승인** (선택적)
  - 요양원 직원이 가족 회원 가입 승인
- [ ] **회원 정지/해제**
  - 문제가 있는 회원 정지
- [ ] **회원 역할 변경**
  - 가족 회원 ↔ 요양원 직원 변경 (ADMIN만)

---

### 4. 입소자 관리 기능

#### 입소자 CRUD
- [ ] **입소자 등록 페이지** (`/residents/new`)
  - 이름, 생년월일, 성별, 호실, 사진 등
  - CAREGIVER만 접근 가능
- [ ] **입소자 목록 페이지** (`/residents`)
  - 소속 요양원의 입소자 목록
  - 검색, 필터링 기능
- [ ] **입소자 상세 페이지** (`/residents/[id]`)
  - 입소자 정보
  - 관련 게시글, 의료 기록 링크
- [ ] **입소자 수정/삭제**
  - 정보 수정
  - 삭제 (가족 승인 필요)

#### 입소자 API
- [ ] **입소자 목록 API** (`GET /api/residents`)
  - 소속 요양원의 입소자만 조회
  - CAREGIVER: 모든 입소자
  - FAMILY: 연결된 입소자만
- [ ] **입소자 등록 API** (`POST /api/residents`)
- [ ] **입소자 수정 API** (`PATCH /api/residents/[id]`)
- [ ] **입소자 삭제 API** (`DELETE /api/residents/[id]`)

---

### 5. 가족-입소자 연결 기능

#### 연결 요청/승인
- [ ] **가족-입소자 연결 요청**
  - FAMILY가 입소자와 연결 요청
  - 관계 선택 (부, 모, 자녀, 배우자 등)
- [ ] **연결 승인/거부**
  - CAREGIVER가 연결 요청 승인/거부
- [ ] **연결 해제**
  - 가족 또는 요양원 직원이 연결 해제

#### 데이터베이스 스키마 추가 필요
```prisma
model ResidentFamily {
  id         String   @id @default(cuid())
  residentId String
  resident   Resident @relation(fields: [residentId], references: [id])
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  relationship String // 부, 모, 자녀, 배우자 등
  isApproved Boolean  @default(false)
  approvedBy String?  // 승인한 CAREGIVER ID
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@unique([residentId, userId])
  @@index([residentId])
  @@index([userId])
}
```

#### API
- [ ] **연결 요청 API** (`POST /api/residents/[id]/family-request`)
- [ ] **연결 승인/거부 API** (`PATCH /api/residents/family-request/[id]`)
- [ ] **연결 해제 API** (`DELETE /api/residents/[id]/family/[userId]`)
- [ ] **내가 연결된 입소자 목록** (`GET /api/users/me/residents`)

---

### 6. 권한 기반 접근 제어

#### 미들웨어 강화
- [ ] **역할별 페이지 접근 제어**
  - FAMILY: 특정 페이지 접근 제한
  - CAREGIVER: 관리 페이지 접근 가능
- [ ] **데이터 필터링**
  - FAMILY는 연결된 입소자 데이터만 조회
  - CAREGIVER는 소속 요양원 데이터만 조회

#### API 권한 검증
- [ ] **모든 API에 역할 검증 추가**
  - 게시글 작성: CAREGIVER만
  - 입소자 등록: CAREGIVER만
  - 의료 기록 작성: CAREGIVER만

---

### 7. 추가 기능

#### 알림 시스템
- [ ] **알림 데이터베이스 모델**
  - 알림 타입 (게시글, 댓글, 의료 기록, 주문 등)
  - 알림 수신자 (특정 사용자 또는 요양원 전체)
- [ ] **알림 API**
  - 알림 목록 조회
  - 알림 읽음 처리
  - 알림 삭제
- [ ] **실시간 알림**
  - WebSocket 또는 Server-Sent Events

#### 통계 및 리포트
- [ ] **요양원별 통계**
  - 회원 수, 입소자 수
  - 게시글 수, 의료 기록 수
- [ ] **입소자별 활동 내역**
  - 게시글, 의료 기록 히스토리

---

## 📝 데이터베이스 스키마 추가 필요

### 1. ResidentFamily 모델 추가
가족-입소자 연결 관계 저장

### 2. Notification 모델 추가
```prisma
model Notification {
  id        String   @id @default(cuid())
  type      NotificationType
  title     String
  content   String?  @db.Text
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  relatedId String?  // 관련 게시글 ID 등
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
}

enum NotificationType {
  PostCreated
  CommentCreated
  MedicalRecordCreated
  OrderCreated
  FamilyRequest
  Other
}
```

### 3. User 모델 확장 (선택적)
```prisma
model User {
  // 기존 필드...
  
  // 추가 가능한 필드
  verifiedAt    DateTime?  // 실명인증 완료 시간
  phoneVerified Boolean    @default(false)
  isActive      Boolean    @default(true)
  suspendedAt   DateTime?
  residentFamilies ResidentFamily[]
  notifications Notification[]
}
```

---

## 🎯 우선순위별 구현 계획

### Phase 1: 핵심 기능 (1-2주)
1. **회원정보 수정 기능**
   - 프로필 수정 페이지
   - 비밀번호 변경
   - API 구현
2. **입소자 관리 기능**
   - 입소자 등록/목록/수정
   - API 구현
3. **가족-입소자 연결 기능**
   - 연결 요청/승인
   - 데이터베이스 스키마 추가
   - API 구현

### Phase 2: 관리 기능 (1주)
1. **요양원 회원 관리**
   - 회원 목록 조회
   - 회원 승인/관리
2. **권한 기반 접근 제어**
   - 역할별 페이지 접근 제어
   - API 권한 검증 강화

### Phase 3: 추가 기능 (1주)
1. **알림 시스템**
   - 알림 모델 및 API
   - 실시간 알림
2. **통계 및 리포트**

---

## 📋 체크리스트

### 회원정보 수정
- [ ] 프로필 수정 페이지
- [ ] 비밀번호 변경 페이지
- [ ] 프로필 사진 업로드
- [ ] 회원정보 조회 API
- [ ] 회원정보 수정 API
- [ ] 비밀번호 변경 API

### 입소자 관리
- [ ] 입소자 등록 페이지
- [ ] 입소자 목록 페이지
- [ ] 입소자 상세 페이지
- [ ] 입소자 수정/삭제
- [ ] 입소자 API 전체

### 가족-입소자 연결
- [ ] 연결 요청 기능
- [ ] 연결 승인/거부 기능
- [ ] 연결 해제 기능
- [ ] 데이터베이스 스키마 추가
- [ ] 연결 API 전체

### 요양원 회원 관리
- [ ] 회원 목록 페이지
- [ ] 회원 검색/필터링
- [ ] 회원 승인/정지 기능
- [ ] 회원 관리 API

### 권한 관리
- [ ] 역할별 페이지 접근 제어
- [ ] API 권한 검증 강화
- [ ] 데이터 필터링 로직

### 알림 시스템
- [ ] 알림 데이터베이스 모델
- [ ] 알림 API
- [ ] 실시간 알림
- [ ] 알림 설정

---

## 💡 구현 시 고려사항

### 보안
- 회원정보 수정 시 현재 비밀번호 확인 필수
- 요양원 변경 시 승인 프로세스 필수
- 입소자 삭제 시 가족 승인 필수
- 모든 API에 역할 검증 추가

### 사용자 경험
- 직관적인 UI/UX
- 명확한 권한 안내
- 간편한 입소자 연결 프로세스

### 데이터 무결성
- 입소자 삭제 시 관련 데이터 처리 (소프트 삭제 권장)
- 회원 탈퇴 시 데이터 보관 정책

---

어떤 기능부터 구현할까요? 우선순위를 알려주시면 바로 시작하겠습니다!

