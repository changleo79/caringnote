# 🔧 데이터베이스 오류 해결 가이드

## 🚨 현재 문제

데이터베이스 오류가 계속 발생하는 경우, 다음 단계를 순서대로 확인하세요.

---

## 1️⃣ 환경 변수 확인

### Vercel에서 확인
1. Vercel 대시보드 → 프로젝트 선택
2. **Settings** → **Environment Variables**
3. 다음 변수들이 있는지 확인:
   - `DATABASE_URL` ✅ 필수
   - `POSTGRES_PRISMA_URL` (선택)
   - `POSTGRES_URL` (선택)

**없으면:**
- Storage 탭 → 데이터베이스 클릭 → Connection String 복사
- Settings → Environment Variables → `DATABASE_URL` 추가
- 모든 환경(Production, Preview, Development) 체크
- **재배포 필수!**

---

## 2️⃣ 데이터베이스 연결 테스트

브라우저에서 다음 URL로 접속하여 상태 확인:

```
https://your-app.vercel.app/api/db-check
```

**결과 확인:**
- ✅ **연결 성공**: `connection.status: "✅ 연결 성공"`
- ❌ **연결 실패**: 오류 메시지 확인

**오류 코드별 해결:**
- `P1001`: 연결 불가 → DATABASE_URL 확인
- `P1000`: 인증 실패 → Connection String의 비밀번호 확인
- `P2025`: 테이블 없음 → 마이그레이션 필요

---

## 3️⃣ 로컬에서 테스트

터미널에서 실행:

```bash
# 1. 환경 변수 가져오기
vercel env pull .env.local

# 2. 연결 테스트
npx prisma db execute --stdin
# (빈 입력 후 Ctrl+C로 종료)

# 또는 간단히:
npx prisma db push --skip-generate
```

---

## 4️⃣ 마이그레이션 실행

데이터베이스 테이블이 없는 경우:

### 방법 A: 로컬에서 실행
```bash
# 환경 변수 가져오기
vercel env pull .env.local

# 마이그레이션 실행
npx prisma migrate dev --name init

# 또는 테이블 생성만
npx prisma db push
```

### 방법 B: Vercel에서 실행
1. Vercel CLI 설치 및 로그인
2. `vercel link` 실행
3. `vercel env pull .env.local`
4. `npx prisma migrate deploy` 실행

---

## 5️⃣ 시드 데이터 생성

테이블은 있지만 데이터가 없는 경우:

```bash
npm run db:seed
```

또는 브라우저에서:
```
https://your-app.vercel.app/api/care-centers/seed
```

---

## 🔍 진단 체크리스트

- [ ] `DATABASE_URL` 환경 변수가 Vercel에 설정되어 있나요?
- [ ] 환경 변수 설정 후 재배포를 했나요?
- [ ] `/api/db-check`에서 연결 상태가 성공인가요?
- [ ] 데이터베이스가 "Active" 상태인가요? (Vercel Storage)
- [ ] 마이그레이션이 실행되었나요?
- [ ] 시드 데이터가 생성되었나요?

---

## 🆘 여전히 안 되나요?

### 오류 메시지 확인
회원가입 시 정확한 오류 메시지를 확인하세요:

1. **"데이터베이스 연결 오류"**
   → DATABASE_URL 확인, 재배포

2. **"존재하지 않는 요양원입니다"**
   → 시드 데이터 생성 필요

3. **"이미 등록된 이메일입니다"**
   → 정상 동작 (다른 이메일 사용)

### 로그 확인
Vercel 대시보드에서:
1. **Deployments** → 최신 배포 클릭
2. **Functions** 로그 확인
3. 오류 메시지 확인

---

## 📞 빠른 해결

가장 빠른 해결 방법:

```bash
# 1. 환경 변수 가져오기
vercel env pull .env.local

# 2. 마이그레이션
npx prisma migrate dev --name init

# 3. 시드 데이터
npm run db:seed

# 4. 배포
vercel --prod
```

**또는:**

1. Vercel Settings → Environment Variables → `DATABASE_URL` 확인
2. 없으면 Storage에서 Connection String 복사해서 추가
3. 재배포 (Deployments → Redeploy)
4. `/api/db-check`로 확인

---

**문제가 계속되면 `/api/db-check` 결과를 알려주세요!**

